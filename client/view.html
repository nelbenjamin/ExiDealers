<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse Cars | Exi Dealers</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1669192747799799');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1669192747799799&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta¬†Pixel¬†Code¬†-->
  <script>
    // Force favicon update
    const favicon = document.querySelector('link[rel="icon"]');
    if (favicon) {
        // Add timestamp to bypass cache
        const timestamp = new Date().getTime();
        favicon.href = 'favicon.png?' + timestamp;
        
        // Create new link element as backup
        const newFavicon = document.createElement('link');
        newFavicon.rel = 'icon';
        newFavicon.href = 'favicon.png?' + timestamp;
        newFavicon.type = 'image/png';
        document.head.appendChild(newFavicon);
    }
</script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="styles.css" rel="stylesheet" />
 <style>

/* 1. HIDE BUTTONS BY DEFAULT */
.car-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 10;
    display: flex;
    flex-direction: row;
    opacity: 0; /* HIDDEN BY DEFAULT */
    visibility: hidden; /* HIDDEN BY DEFAULT */
    transform: translateX(10px); /* Start slightly off-screen */
    transition: all 0.3s ease;
}

/* 2. SHOW BUTTONS ONLY ON HOVER */
.car-card:hover .car-actions {
    opacity: 1; /* VISIBLE ON HOVER */
    visibility: visible; /* VISIBLE ON HOVER */
    transform: translateX(0); /* Slide into position */
}

/* 3. FIX ZOOMED IMAGES - Remove or change object-fit */
.car-card img {
    object-fit: contain; /* Changed from 'cover' to 'contain' to show full image */
    height: 180px;
    width: 100%; /* Ensure full width */
    background-color: #f8f9fa; /* Add background for images with aspect ratio */
}

.car-image-container {
    position: relative;
    height: 200px;
    overflow: hidden;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa; /* Background for container */
}

.main-car-image {
    width: auto; /* Changed from 100% to auto */
    max-width: 100%; /* Ensure it doesn't overflow */
    max-height: 100%; /* Ensure it doesn't overflow */
    object-fit: contain; /* Changed from 'cover' to 'contain' */
    transition: opacity 0.3s ease;
}

/* 4. Optional: Add a subtle scale effect on image hover */
.car-card:hover .main-car-image {
    transform: scale(1.02);
    transition: transform 0.3s ease;
}

/* 5. Ensure the car card has relative positioning for proper button placement */
.car-card {
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
    height: 100%;
    overflow: hidden; /* Ensure nothing spills out */
}

/* 6. Improve button appearance */
.car-action-btn {
    background: rgba(255, 255, 255, 0.95);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    margin-left: 8px;
    backdrop-filter: blur(2px); /* Optional: adds glass effect */
}

/* 7. Make sure the entire card area triggers hover */
.car-card .card-body {
    position: relative;
    z-index: 1;
}

/* 8. Make the image container fill the top portion of card */
.car-card .car-image-container {
    height: 220px; /* Adjust as needed */
    background-color: #f8f9fa; /* Light background for images */
}

    .car-card img {
      object-fit: cover;
      height: 180px;
    }
    
    .car-card .details {
    margin-bottom: 0 !important;
}

    .browse-header {
        background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7));
        background-size: cover;
        background-position: center;
    }
    
    /* Background for all pages */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('https://images.unsplash.com/photo-1568605117036-5fe5e7bab0b7?ixlib=rb-4.0.3&auto=format&fit=crop&w=1800&q=80') no-repeat center center;
        background-size: cover;
        z-index: -2;
        opacity: 0;
        transition: opacity 2s ease-in-out;
        filter: brightness(0.8);
    }
    
    body.background-loaded::before {
        opacity: 0.8;
    }
    
    /* Ensure content has proper background */
    .bg-white, .bg-light, .card {
        background-color: rgba(255, 255, 255, 0.95) !important;
    }
    
    .modal-content {
        background-color: rgba(255, 255, 255, 0.98) !important;
    }
    
    /* Footer should remain solid dark */
    .footer {
        background: #1a1a1a !important;
    }
    
    /* Car Actions */
    .car-actions {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 10;
        display: flex;
        flex-direction: row;
    }
    
    .car-action-btn {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        margin-left: 8px;
    }
    
    .car-action-btn:first-child {
        margin-left: 0;
    }
    
    .car-action-btn:hover {
        background: #fff;
        transform: scale(1.15);
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    
    .car-action-btn.favorite-btn:hover {
        color: #dc3545;
    }
    
    .car-action-btn.save-btn:hover {
        color: #0d6efd;
    }
    
    .car-action-btn.price-alert-btn:hover {
        color: #ffc107;
        background: rgba(255, 193, 7, 0.2);
    }
    
    .car-action-btn.active {
        background: #0d6efd;
        color: white;
    }
    
    .car-action-btn.favorited {
        color: #dc3545;
        background: rgba(220, 53, 69, 0.15);
    }
    
    /* Toast styling */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }

    /* Car Image Carousel Styles */
    .car-image-container {
        position: relative;
        height: 200px;
        overflow: hidden;
        cursor: pointer;
    }
    
    .main-car-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.3s ease;
    }
    
    .carousel-controls {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px;
        z-index: 5;
    }
    
    .carousel-btn {
        background: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .carousel-btn:hover {
        background: #fff;
        transform: scale(1.1);
    }
    
    .image-counter {
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
    }
    
    /* Filter Sidebar Styles */
    .filter-sidebar {
        position: fixed;
        top: 0;
        right: -400px;
        width: 380px;
        height: 100vh;
        background: white;
        box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        transition: right 0.3s ease-in-out;
        z-index: 1050;
        overflow-y: auto;
        padding: 20px;
    }
    
    .filter-sidebar.active {
        right: 0;
    }
    
    .filter-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
        display: none;
    }
    
    .filter-overlay.active {
        display: block;
    }
    
    .filter-section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .filter-section h6 {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
    }
    
    .filter-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .filter-input-group input {
        flex: 1;
    }
    
    .filter-checkbox-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    
    .filter-checkbox-group label {
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .filter-tag {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-tag:hover, .filter-tag.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .filter-actions {
        position: sticky;
        bottom: 0;
        background: white;
        padding: 15px 0;
        border-top: 1px solid #eee;
        margin-top: 20px;
    }

    /* Filter button in header */
    .filter-toggle-btn {
        background: #6c757d;
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        transition: all 0.3s;
    }
    
    .filter-toggle-btn:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }

    /* FIXED: Card styles with NO white space below button */
    .car-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        height: 100%;
    }
    
    .car-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .car-card .card-body {
        padding: 1rem 1rem 0.25rem 1rem !important;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .car-card .card-title {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    
    .car-card .price {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }
    
    .car-card .details {
         margin-bottom: 0.25rem !important;
    }
    
    .car-card .btn {
        margin-top: auto;
        margin-bottom: 0 !important;
    }
    
    /* Remove any extra padding/margin from card itself */
    .card {
        padding-bottom: 0 !important;
    }
    
    /* 5 cards per row on large screens */
    @media (min-width: 1400px) {
        .col-xxl {
            flex: 0 0 auto;
            width: 20%;
        }
    }
    
    /* Badge styles */
    .spec-badge {
        font-size: 0.7rem;
        padding: 3px 6px;
        margin: 1px;
    }

    .navbar-brand img {
        filter: brightness(0) invert(1);
        height: 60px !important; /* Increased to match index page */
        width: auto;
    }

    /* Pagination Styles */
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 3rem;
        margin-bottom: 2rem;
    }
    
    .pagination {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    /* Search Dropdown Styles */
    .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 400px;
        overflow-y: auto;
        display: none;
    }
    
    .search-dropdown.show {
        display: block;
    }
    
    .search-dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f8f9fa;
        cursor: pointer;
        transition: background-color 0.15s;
    }
    
    .search-dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    .search-dropdown-item:last-child {
        border-bottom: none;
    }
    
    .search-checkbox {
        margin-right: 0.75rem;
    }
    
    .search-item-count {
        margin-left: auto;
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        min-width: 2rem;
        text-align: center;
    }
    
    .search-item-main {
        font-weight: 600;
    }
    
    .search-item-sub {
        font-size: 0.875rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }
    
    /* View Controls */
    .view-controls {
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .view-btn {
        border: none;
        background: transparent;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        transition: all 0.3s;
    }
    
    .view-btn.active {
        background: #007bff;
        color: white;
    }
    
    .view-btn:not(.active):hover {
        background: #e9ecef;
    }

    /* Full width car listings */
    .car-listings-container {
        padding-left: 5px;
        padding-right: 5px;
        max-width: 100%;
    }

    /* Search section with reduced spacing */
    .search-section {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    /* FIX: White text for error messages ONLY */
#carsContainer .col-12.text-center .text-muted,
#carsContainer .col-12.text-center .text-muted h5,
#carsContainer .col-12.text-center .text-muted p {
    color: white !important;
}

.car-card {
    height: 380px !important; /* Reduce this number to make cards shorter */
}

.car-card .card-body {
    padding: 0.75rem !important; /* Reduce padding inside card */
}

.car-image-container {
    height: 280px !important; /* Reduce image height */
}

/* NEW: Increased header/navigation size to match index page */
.navbar {
    padding-top: 0.7rem; /* Increased to match index page */
    padding-bottom: 0.7rem; /* Increased to match index page */
    min-height: 80px; /* Increased to match index page */
}

.nav-link {
    font-size: 1rem !important; /* Increased to match index page */
    padding: 0.6rem 1rem !important; /* Increased padding to match index page */
    font-weight: 600 !important; /* Added font weight for better visibility */
}

/* NEW: Reduced page header text sizes */
.browse-header h1 {
    font-size: 2.5rem !important; /* Reduced from display-4 */
    margin-bottom: 1rem !important;
}

.browse-header .lead {
    font-size: 1.1rem !important; /* Reduced size */
}

/* NEW: Reduced card text sizes */
.card-header h3 {
    font-size: 1.3rem !important; /* Reduced size */
}

.card h5 {
    font-size: 1.1rem !important; /* Reduced size */
}

/* NEW: Consistent footer text sizes */
.footer h5 {
    font-size: 1.1rem !important; /* Consistent heading size */
    margin-bottom: 1rem !important;
}

.footer p, .footer li, .footer a {
    font-size: 0.9rem !important; /* Consistent text size */
}
</style>
</head>
<body>
  <!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="index.html">
            <img src="logo.png" alt="Exi Dealers Logo" style="height: 70px; width: auto;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/view">Browse Cars</a></li>
                <li class="nav-item"><a class="nav-link" href="/contact">Contact Us</a></li>
                <li class="nav-item dropdown" id="userDropdownContainer">
                    <!-- User dropdown will be inserted here by JavaScript -->
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
// Add this script to the bottom of each page (before closing body tag)
document.addEventListener('DOMContentLoaded', async function() {
    await loadUserNavigation();
});

async function loadUserNavigation() {
    try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        
        const container = document.getElementById('userDropdownContainer');
        
        if (data.authenticated) {
            container.innerHTML = `
                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                    <span class="user-initials" style="width: 35px; height: 35px; background: #ffc107; color: #1a365d; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 5px;">
                        ${data.user.initials}
                    </span>
                    ${data.user.firstName}
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>My Profile</a></li>
                    <li><a class="dropdown-item" href="/profile#favorites"><i class="fas fa-heart me-2"></i>Favorites</a></li>
                    <li><a class="dropdown-item" href="/profile#saved"><i class="fas fa-bookmark me-2"></i>Saved Cars</a></li>
                    <li><a class="dropdown-item" href="/profile#alerts"><i class="fas fa-bell me-2"></i>Price Alerts</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="logoutUser()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                </ul>
            `;
        } else {
            container.innerHTML = `
                <li class="nav-item"><a class="nav-link" href="/login"><i class="fas fa-sign-in-alt me-1"></i>Sign In</a></li>
                <li class="nav-item"><a class="nav-link" href="/register"><i class="fas fa-user-plus me-1"></i>Register</a></li>
            `;
        }
        
        // Initialize Bootstrap dropdown
        const dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
        dropdownElementList.map(function (dropdownToggleEl) {
            return new bootstrap.Dropdown(dropdownToggleEl);
        });
        
    } catch (error) {
        console.error('Error loading navigation:', error);
    }
}

async function logoutUser() {
    try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.reload();
    } catch (error) {
        console.error('Logout error:', error);
    }
}
</script>

<style>
.user-initials {
    width: 35px;
    height: 35px;
    background: #ffc107;
    color: #1a365d;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    margin-right: 5px;
}
</style>

  <!-- Page Header -->
  <header class="browse-header py-5 bg-primary text-white text-center">
    <div class="container">
      <h1 class="display-4 fw-bold">Browse Cars</h1>
      <p class="lead">Find your next vehicle from our wide selection</p>
    </div>
  </header>

  <!-- View Controls -->
  <section class="py-3 bg-light">
    <div class="container">
      <div class="view-controls d-flex justify-content-center gap-2">
        <button class="view-btn active" data-view="all">
          <i class="fas fa-car me-1"></i>All Cars
        </button>
        <button class="view-btn" data-view="favorites">
          <i class="fas fa-heart me-1"></i>Favorites
        </button>
        <button class="view-btn" data-view="saved">
          <i class="fas fa-bookmark me-1"></i>Saved for Later
        </button>
      </div>
    </div>
  </section>

  <!-- Search & Filter Controls - REDUCED SPACING -->
  <section class="search-section bg-light">
    <div class="container">
        <div class="row g-3 align-items-center">
            <!-- Search with Dropdown -->
            <div class="col-md-3 position-relative">
                <input type="text" id="searchInput" class="form-control" placeholder="Search by make, model, or location">
                <div class="search-dropdown" id="searchDropdown">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
            
            <!-- Dynamic Brand Filter -->
            <div class="col-md-2">
                <select id="brandFilter" class="form-select">
                    <option value="">All Brands</option>
                    <!-- Dynamic options will be inserted here -->
                </select>
            </div>
            
            <div class="col-md-2">
                <select id="priceFilter" class="form-select">
                    <option value="">Price Range</option>
                    <option value="0-10000">Under N$10,000</option>
                    <option value="10000-20000">N$10,000 - N$20,000</option>
                    <option value="20000-30000">N$20,000 - N$30,000</option>
                    <option value="30000-50000">N$30,000 - N$50,000</option>
                    <option value="50000-100000">N$50,000 - N$100,000</option>
                    <option value="100000-9999999">Over N$100,000</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <select id="sortFilter" class="form-select">
                    <option value="">Sort by</option>
                    <option value="priceLowHigh">Price: Low to High</option>
                    <option value="priceHighLow">Price: High to Low</option>
                    <option value="yearNewOld">Year: New to Old</option>
                    <option value="yearOldNew">Year: Old to New</option>
                </select>
            </div>
            
            <div class="col-md-3 text-end">
                <button class="btn btn-secondary filter-toggle-btn" id="filterToggle">
                    <i class="fas fa-filter me-2"></i>Filters
                </button>
            </div>
        </div>
    </div>
  </section>

  <!-- Filter Sidebar - RESTORED TO ORIGINAL STYLING -->
  <div class="filter-overlay" id="filterOverlay"></div>
  <div class="filter-sidebar" id="filterSidebar">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5>Filter Cars</h5>
        <button class="btn-close" id="closeFilter"></button>
    </div>
    
    <div class="filter-section">
        <h6>Price Range (N$)</h6>
        <div class="filter-input-group">
            <input type="number" class="form-control" id="minPrice" placeholder="Min">
            <input type="number" class="form-control" id="maxPrice" placeholder="Max">
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Location</h6>
        <select class="form-select" id="locationFilter">
            <option value="">All Locations</option>
            <option value="Windhoek">Windhoek</option>
            <option value="Swakopmund">Swakopmund</option>
            <option value="Walvis Bay">Walvis Bay</option>
            <option value="Oshakati">Oshakati</option>
            <option value="Other">Other</option>
        </select>
    </div>
    
    <div class="filter-section">
        <h6>Body Type</h6>
        <div class="filter-checkbox-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="SUV" id="bodySUV">
                <label class="form-check-label" for="bodySUV">SUV</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Sedan" id="bodySedan">
                <label class="form-check-label" for="bodySedan">Sedan</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Hatchback" id="bodyHatchback">
                <label class="form-check-label" for="bodyHatchback">Hatchback</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Coupe" id="bodyCoupe">
                <label class="form-check-label" for="bodyCoupe">Coupe</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Convertible" id="bodyConvertible">
                <label class="form-check-label" for="bodyConvertible">Convertible</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Truck" id="bodyTruck">
                <label class="form-check-label" for="bodyTruck">Truck</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Van" id="bodyVan">
                <label class="form-check-label" for="bodyVan">Van</label>
            </div>
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Year</h6>
        <div class="filter-input-group">
            <input type="number" class="form-control" id="minYear" placeholder="Min Year" min="1980" max="2025">
            <input type="number" class="form-control" id="maxYear" placeholder="Max Year" min="1980" max="2025">
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Mileage</h6>
        <div class="filter-input-group">
            <input type="number" class="form-control" id="minMileage" placeholder="Min km">
            <input type="number" class="form-control" id="maxMileage" placeholder="Max km">
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Transmission</h6>
        <div class="filter-checkbox-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Automatic" id="transAuto">
                <label class="form-check-label" for="transAuto">Automatic</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Manual" id="transManual">
                <label class="form-check-label" for="transManual">Manual</label>
            </div>
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Fuel Type</h6>
        <div class="filter-checkbox-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Petrol" id="fuelPetrol">
                <label class="form-check-label" for="fuelPetrol">Petrol</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Diesel" id="fuelDiesel">
                <label class="form-check-label" for="fuelDiesel">Diesel</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Electric" id="fuelElectric">
                <label class="form-check-label" for="fuelElectric">Electric</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="Hybrid" id="fuelHybrid">
                <label class="form-check-label" for="fuelHybrid">Hybrid</label>
            </div>
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Drive Type</h6>
        <div class="filter-checkbox-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="4x2" id="drive4x2">
                <label class="form-check-label" for="drive4x2">4x2</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="4x4" id="drive4x4">
                <label class="form-check-label" for="drive4x4">4x4</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="AWD" id="driveAWD">
                <label class="form-check-label" for="driveAWD">AWD</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="FWD" id="driveFWD">
                <label class="form-check-label" for="driveFWD">FWD</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="RWD" id="driveRWD">
                <label class="form-check-label" for="driveRWD">RWD</label>
            </div>
        </div>
    </div>
    
    <div class="filter-section">
        <h6>Condition</h6>
        <div class="filter-checkbox-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="excellent" id="condExcellent">
                <label class="form-check-label" for="condExcellent">Excellent</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="good" id="condGood">
                <label class="form-check-label" for="condGood">Good</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="fair" id="condFair">
                <label class="form-check-label" for="condFair">Fair</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="poor" id="condPoor">
                <label class="form-check-label" for="condPoor">Poor</label>
            </div>
        </div>
    </div>
    
    <div class="filter-actions">
        <div class="d-grid gap-2">
            <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
            <button class="btn btn-outline-secondary" id="resetFilters">Reset Filters</button>
        </div>
    </div>
  </div>

  <!-- Car Listings - FULL WIDTH WITH MINIMAL SIDE MARGINS -->
  <section class="py-3"> <!-- Reduced padding -->
    <div class="container-fluid car-listings-container"> <!-- Changed to container-fluid for full width -->
      <div id="carsContainer" class="row g-2"> <!-- Reduced gap from g-3 to g-2 -->
      </div>
      
      <!-- Pagination -->
      <div id="paginationContainer" class="pagination-container">
        <nav aria-label="Car listings pagination">
          <ul id="pagination" class="pagination">
            <!-- Pagination will be generated here -->
          </ul>
        </nav>
      </div>
    </div>
  </section>

  <!-- Price Drop Alert Modal -->
  <div class="modal fade" id="priceAlertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Don't Miss a Deal!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Be the first to know when this car (or similar ones) drops in price. Enter your details and we'll alert you instantly.</p>
                <form id="priceAlertForm">
                    <input type="hidden" id="alertCarId">
                    <input type="hidden" id="alertCarMake">
                    <input type="hidden" id="alertCarModel">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alertFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="alertFirstName" required placeholder="Enter first name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alertLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="alertLastName" required placeholder="Enter last name">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="alertPhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="alertPhone" required placeholder="Enter phone number">
                    </div>
                    <div class="mb-3">
                        <label for="alertEmail" class="form-label">Your Email</label>
                            <input type="email" class="form-control" id="alertEmail" required placeholder="Enter your email">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="similarCars" checked>
                        <label class="form-check-label" for="similarCars">Also alert me about similar cars</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitPriceAlert">Send Me Alerts</button>
            </div>
        </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Global variables
let allCars = [];
let currentFilters = {};
let currentPage = 1;
const carsPerPage = 15;
let totalCars = 0;
let totalPages = 1;
let currentView = 'all';
let availableBrands = new Set();
let availableBrandsModels = {};
let searchTimeout;

// DOM Ready
document.addEventListener('DOMContentLoaded', function () {
    console.log('üöó View page loaded');
    
    // Make the background emerge
    setTimeout(() => {
        document.body.classList.add('background-loaded');
    }, 100);
    
    // Check for budget filters from homepage FIRST
    checkForBudgetFilters();
    
    // Load cars immediately
    fetchCars(1);
    
    // Initialize all functionality
    initFilters();
    initSearchDropdown();
    initViewControls();
    initFooterBrandLinks();
});

// NEW: Check for budget filters from homepage - FIXED VERSION
function checkForBudgetFilters() {
    const urlParams = new URLSearchParams(window.location.search);
    
    console.log('üîç Checking URL parameters:', Object.fromEntries(urlParams));
    
    // Check if we have budget parameters in the URL
    if (urlParams.has('minPrice') || urlParams.has('maxPrice') || urlParams.has('budgetSearch')) {
        console.log('üí∞ Found budget search parameters in URL');
        
        // Get budget parameters from URL
        const minPrice = urlParams.get('minPrice');
        const maxPrice = urlParams.get('maxPrice');
        const bodyType = urlParams.get('bodyTypes');
        const minYear = urlParams.get('minYear');
        const maxYear = urlParams.get('maxYear');
        
        console.log('üìä Budget parameters from URL:', { minPrice, maxPrice, bodyType, minYear, maxYear });
        
        // Set filter sidebar inputs
        if (minPrice) document.getElementById('minPrice').value = minPrice;
        if (maxPrice) document.getElementById('maxPrice').value = maxPrice;
        
        // Set year range if provided
        if (minYear) document.getElementById('minYear').value = minYear;
        if (maxYear) document.getElementById('maxYear').value = maxYear;
        
        // Set body type checkbox if provided
        if (bodyType) {
            const bodyCheckbox = document.querySelector(`input[type="checkbox"][value="${bodyType}"]`);
            if (bodyCheckbox) {
                bodyCheckbox.checked = true;
            }
        }
        
        // Set current filters
        currentFilters = {
            minPrice: minPrice ? parseFloat(minPrice) : null,
            maxPrice: maxPrice ? parseFloat(maxPrice) : null,
            minYear: minYear ? parseInt(minYear) : null,
            maxYear: maxYear ? parseInt(maxYear) : null,
            bodyTypes: bodyType ? [bodyType] : [],
            location: '',
            transmissions: [],
            fuelTypes: [],
            driveTypes: [],
            conditions: [],
            minMileage: null,
            maxMileage: null
        };
        
        console.log('üìã Current filters set from URL:', currentFilters);
        
        // Show notification
        const rangeText = minPrice && maxPrice 
            ? `N$${parseInt(minPrice).toLocaleString()} - N$${parseInt(maxPrice).toLocaleString()}`
            : minPrice ? `above N$${parseInt(minPrice).toLocaleString()}` 
            : maxPrice ? `under N$${parseInt(maxPrice).toLocaleString()}` 
            : 'your budget';
        
        showToast(`Showing cars within ${rangeText}`);
        
        // Update page title to reflect budget search
        document.querySelector('.browse-header h1').textContent = `Cars Within Your Budget`;
        document.querySelector('.browse-header .lead').textContent = `Find vehicles that match your financial plan`;
    }
}

// Initialize search dropdown functionality
function initSearchDropdown() {
    const searchInput = document.getElementById('searchInput');
    const searchDropdown = document.getElementById('searchDropdown');
    
    if (searchInput) {
        // Show dropdown on focus
        searchInput.addEventListener('focus', function() {
            if (Object.keys(availableBrandsModels).length > 0) {
                updateSearchDropdown('');
                searchDropdown.classList.add('show');
            }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                searchDropdown.classList.remove('show');
            }
        });
        
        // Update dropdown on input
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                updateSearchDropdown(this.value);
                searchDropdown.classList.add('show');
            }, 50);
        });
    }
}

// Update search dropdown content
function updateSearchDropdown(searchTerm = '') {
    const searchDropdown = document.getElementById('searchDropdown');
    if (!searchDropdown) return;
    
    let html = '';
    const term = searchTerm.toLowerCase().trim();
    
    // Add "Any" option (pre-selected)
    html += `
        <div class="search-dropdown-item" data-type="any">
            <input type="checkbox" class="form-check-input search-checkbox" id="search-any" checked>
            <label for="search-any" class="search-item-main">Any</label>
            <span class="search-item-count">${totalCars}</span>
        </div>
    `;
    
    // Add brands and models
    Object.keys(availableBrandsModels).sort().forEach(brand => {
        const brandLower = brand.toLowerCase();
        const models = availableBrandsModels[brand];
        const brandCount = models.reduce((sum, model) => sum + model.count, 0);
        
        // Show brand if it matches search term or if no search term
        if (!term || brandLower.includes(term)) {
            html += `
                <div class="search-dropdown-item" data-type="brand" data-value="${brand}">
                    <input type="checkbox" class="form-check-input search-checkbox" id="search-${brand}">
                    <label for="search-${brand}" class="search-item-main">${brand}</label>
                    <span class="search-item-count">${brandCount}</span>
                </div>
            `;
        }
        
        // Show models for this brand that match search term
        models.forEach(model => {
            const modelLower = model.name.toLowerCase();
            if (term && modelLower.includes(term) && !brandLower.includes(term)) {
                html += `
                    <div class="search-dropdown-item" data-type="model" data-brand="${brand}" data-value="${model.name}">
                        <input type="checkbox" class="form-check-input search-checkbox" id="search-${brand}-${model.name}">
                        <span class="search-item-main">${brand}</span>
                        <span class="search-item-sub">${model.name}</span>
                        <span class="search-item-count">${model.count}</span>
                    </div>
                `;
            }
        });
    });
    
    searchDropdown.innerHTML = html;
    
    // Add event listeners to dropdown items
    searchDropdown.querySelectorAll('.search-dropdown-item').forEach(item => {
        item.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            }
            
            const type = this.getAttribute('data-type');
            const value = this.getAttribute('data-value');
            const brand = this.getAttribute('data-brand');
            
            if (type === 'any') {
                // Uncheck all other checkboxes
                searchDropdown.querySelectorAll('.search-checkbox').forEach(cb => {
                    if (cb.id !== 'search-any') cb.checked = false;
                });
                document.getElementById('searchInput').value = '';
            } else {
                // Uncheck "Any" and update search input
                document.getElementById('search-any').checked = false;
                if (type === 'brand') {
                    document.getElementById('searchInput').value = value;
                } else if (type === 'model') {
                    document.getElementById('searchInput').value = `${brand} ${value}`;
                }
            }
            
            applyFilters(1);
            searchDropdown.classList.remove('show');
        });
    });
}

// Initialize view controls (All Cars, Favorites, Saved)
function initViewControls() {
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Update current view
            currentView = this.getAttribute('data-view');
            applyFilters(1);
        });
    });
}

// Initialize footer brand links
function initFooterBrandLinks() {
    document.querySelectorAll('.footer a[href="#"]').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const brand = this.textContent.trim();
            document.getElementById('searchInput').value = brand;
            applyFilters(1);
        });
    });
}

// Filter functionality
function initFilters() {
    const filterToggle = document.getElementById('filterToggle');
    const closeFilter = document.getElementById('closeFilter');
    const filterOverlay = document.getElementById('filterOverlay');
    const filterSidebar = document.getElementById('filterSidebar');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');

    // Toggle filter sidebar
    if (filterToggle) {
        filterToggle.addEventListener('click', () => {
            filterSidebar.classList.add('active');
            filterOverlay.classList.add('active');
        });
    }

    if (closeFilter) {
        closeFilter.addEventListener('click', () => {
            filterSidebar.classList.remove('active');
            filterOverlay.classList.remove('active');
        });
    }

    if (filterOverlay) {
        filterOverlay.addEventListener('click', () => {
            filterSidebar.classList.remove('active');
            filterOverlay.classList.remove('active');
        });
    }

    // Apply filters
    if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
            currentFilters = getCurrentFilterValues();
            console.log('üìã Applying new filters:', currentFilters);
            applyFilters(1);
            filterSidebar.classList.remove('active');
            filterOverlay.classList.remove('active');
        });
    }

    // Reset filters
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', resetFilters);
    }

    // Add event listeners for instant search/filter
    const searchInput = document.getElementById('searchInput');
    const brandFilter = document.getElementById('brandFilter');
    const sortFilter = document.getElementById('sortFilter');
    const priceFilter = document.getElementById('priceFilter');

    if (brandFilter) brandFilter.addEventListener('change', () => applyFilters(1));
    if (sortFilter) sortFilter.addEventListener('change', () => applyFilters(1));
    if (priceFilter) priceFilter.addEventListener('change', () => {
        // Clear manual price inputs when using dropdown
        document.getElementById('minPrice').value = '';
        document.getElementById('maxPrice').value = '';
        
        // Get price range from dropdown
        const priceRange = priceFilter.value;
        if (priceRange && priceRange !== '') {
            const [minPrice, maxPrice] = priceRange.split('-').map(Number);
            currentFilters.minPrice = minPrice;
            currentFilters.maxPrice = maxPrice === 9999999 ? null : maxPrice;
        } else {
            // If "Price Range" is selected (empty value), clear price filters
            currentFilters.minPrice = null;
            currentFilters.maxPrice = null;
        }
        
        applyFilters(1);
    });
}

function getCurrentFilterValues() {
    const bodyTypeCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="body"]:checked');
    const transmissionCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="trans"]:checked');
    const fuelTypeCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="fuel"]:checked');
    const driveTypeCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="drive"]:checked');
    const conditionCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="cond"]:checked');

    return {
        minPrice: document.getElementById('minPrice')?.value ? parseInt(document.getElementById('minPrice').value) : null,
        maxPrice: document.getElementById('maxPrice')?.value ? parseInt(document.getElementById('maxPrice').value) : null,
        location: document.getElementById('locationFilter')?.value || '',
        bodyTypes: Array.from(bodyTypeCheckboxes).map(cb => cb.value),
        minYear: document.getElementById('minYear')?.value ? parseInt(document.getElementById('minYear').value) : null,
        maxYear: document.getElementById('maxYear')?.value ? parseInt(document.getElementById('maxYear').value) : null,
        minMileage: document.getElementById('minMileage')?.value ? parseInt(document.getElementById('minMileage').value) : null,
        maxMileage: document.getElementById('maxMileage')?.value ? parseInt(document.getElementById('maxMileage').value) : null,
        transmissions: Array.from(transmissionCheckboxes).map(cb => cb.value),
        fuelTypes: Array.from(fuelTypeCheckboxes).map(cb => cb.value),
        driveTypes: Array.from(driveTypeCheckboxes).map(cb => cb.value),
        conditions: Array.from(conditionCheckboxes).map(cb => cb.value)
    };
}

// FIXED: Enhanced applyFilters function to handle all filter types
function applyFilters(page = 1) {
    console.log('üîç Applying filters for page:', page, 'with filters:', currentFilters);
    currentPage = page;
    
    if (currentView === 'all') {
        fetchCars(page);
    } else {
        // For favorites/saved views, we filter client-side from allCars
        const filteredCars = filterCarsByView(allCars);
        if (filteredCars.length === 0) {
            showEmptyStateForView();
        } else {
            // Simple client-side pagination for favorites/saved
            const startIndex = (page - 1) * carsPerPage;
            const endIndex = startIndex + carsPerPage;
            const paginatedCars = filteredCars.slice(startIndex, endIndex);
            
            totalCars = filteredCars.length;
            totalPages = Math.ceil(totalCars / carsPerPage);
            
            displayCars(paginatedCars);
        }
    }
}

function resetFilters() {
    console.log('üîÑ Resetting all filters');
    
    // Reset all filter inputs
    const inputs = ['minPrice', 'maxPrice', 'minYear', 'maxYear', 'minMileage', 'maxMileage'];
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
    });
    
    const locationFilter = document.getElementById('locationFilter');
    if (locationFilter) locationFilter.value = '';
    
    // Uncheck all checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Reset dropdowns
    document.getElementById('searchInput').value = '';
    document.getElementById('brandFilter').value = '';
    document.getElementById('priceFilter').value = '';
    document.getElementById('sortFilter').value = '';
    
    // Reset view to All Cars
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-view="all"]').classList.add('active');
    currentView = 'all';
    
    // Clear current filters
    currentFilters = {};
    
    // Reset page title
    document.querySelector('.browse-header h1').textContent = `Browse Cars`;
    document.querySelector('.browse-header .lead').textContent = `Find your next vehicle from our wide selection`;
    
    applyFilters(1);
}

// Updated fetchCars function
async function fetchCars(page = 1) {
    console.log('üîç Fetching cars for page:', page, 'with filters:', currentFilters);
    
    try {
        // Build query parameters
        const params = new URLSearchParams({
            page: page,
            limit: carsPerPage
        });

        // Add search and filter parameters
        const searchText = document.getElementById('searchInput')?.value || '';
        const brand = document.getElementById('brandFilter')?.value || '';
        const sort = document.getElementById('sortFilter')?.value || '';

        if (searchText) params.append('search', searchText);
        if (brand) params.append('brand', brand);
        if (sort) params.append('sort', sort);

        // Add advanced filter parameters - FIXED: Send all filter parameters
        if (currentFilters.minPrice !== null && currentFilters.minPrice !== undefined) {
            params.append('minPrice', currentFilters.minPrice);
            console.log('üí∞ Adding minPrice filter:', currentFilters.minPrice);
        }
        if (currentFilters.maxPrice !== null && currentFilters.maxPrice !== undefined) {
            params.append('maxPrice', currentFilters.maxPrice);
            console.log('üí∞ Adding maxPrice filter:', currentFilters.maxPrice);
        }
        if (currentFilters.location) {
            params.append('location', currentFilters.location);
        }
        if (currentFilters.bodyTypes && currentFilters.bodyTypes.length > 0) {
            params.append('bodyTypes', currentFilters.bodyTypes.join(','));
            console.log('üöó Adding bodyTypes filter:', currentFilters.bodyTypes);
        }
        if (currentFilters.transmissions && currentFilters.transmissions.length > 0) {
            params.append('transmissions', currentFilters.transmissions.join(','));
        }
        if (currentFilters.fuelTypes && currentFilters.fuelTypes.length > 0) {
            params.append('fuelTypes', currentFilters.fuelTypes.join(','));
        }
        if (currentFilters.driveTypes && currentFilters.driveTypes.length > 0) {
            params.append('driveTypes', currentFilters.driveTypes.join(','));
        }
        if (currentFilters.conditions && currentFilters.conditions.length > 0) {
            params.append('conditions', currentFilters.conditions.join(','));
        }
        if (currentFilters.minYear !== null && currentFilters.minYear !== undefined) {
            params.append('minYear', currentFilters.minYear);
            console.log('üìÖ Adding minYear filter:', currentFilters.minYear);
        }
        if (currentFilters.maxYear !== null && currentFilters.maxYear !== undefined) {
            params.append('maxYear', currentFilters.maxYear);
            console.log('üìÖ Adding maxYear filter:', currentFilters.maxYear);
        }
        if (currentFilters.minMileage !== null && currentFilters.minMileage !== undefined) {
            params.append('minMileage', currentFilters.minMileage);
        }
        if (currentFilters.maxMileage !== null && currentFilters.maxMileage !== undefined) {
            params.append('maxMileage', currentFilters.maxMileage);
        }

        console.log('üì° Fetching cars with params:', Object.fromEntries(params));
        
        const response = await fetch(`/api/cars?${params}`);
        console.log('üì° Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Paginated data received:', data);
        
        if (data && data.cars && Array.isArray(data.cars)) {
            console.log(`‚úÖ Successfully loaded ${data.cars.length} cars for page ${page}`);
            processCarsData(data.cars, data.pagination);
            
            // Update total cars count display
            updateTotalCarsCount(data.pagination.totalCars);
        } else {
            console.log('‚ùå Invalid data format');
            throw new Error('API returned invalid data format');
        }
        
    } catch (error) {
        console.error('‚ùå Error loading cars from API:', error);
        showEmptyState('Unable to load cars from server. Please try again later.');
    }
}

// Function to update total cars count display
function updateTotalCarsCount(totalCount) {
    // Update "Any" option in search dropdown
    const anyOption = document.querySelector('.search-dropdown-item[data-type="any"] .search-item-count');
    if (anyOption) {
        anyOption.textContent = totalCount;
    }
    
    // Update any other elements that should show total count
    const totalCountElements = document.querySelectorAll('.total-cars-count, .cars-total-count');
    totalCountElements.forEach(element => {
        element.textContent = totalCount;
    });
}

function processCarsData(cars, pagination) {
    if (!cars || !Array.isArray(cars)) {
        throw new Error('No valid data received from API');
    }
    
    console.log(`üöó Processing ${cars.length} cars`);
    
    // Store pagination info
    currentPage = pagination.currentPage;
    totalPages = pagination.totalPages;
    totalCars = pagination.totalCars;
    
    // Process car data
    allCars = cars.map(car => {
        // Handle price - treat as string to preserve exact formatting
        let price = car.price !== null && car.price !== undefined ? car.price.toString() : 'N/A';
        
        // Handle mileage conversion safely
        let mileage = 0;
        if (car.mileage) {
            mileage = parseInt(car.mileage) || 0;
        }
        
        // Handle year conversion safely
        let year = 2020;
        if (car.year) {
            year = parseInt(car.year) || 2020;
        }
        
        // Handle condition - capitalize first letter
        let condition = 'Unknown';
        if (car.condition) {
            condition = car.condition.charAt(0).toUpperCase() + car.condition.slice(1);
        }
        
        // Handle images
        let images = [];
        if (car.images && Array.isArray(car.images)) {
            images = car.images;
        } else if (car.imageUrl) {
            images = [{ imageUrl: car.imageUrl, isPrimary: true }];
        }
        
        return {
            id: car.id,
            make: car.make || 'Unknown',
            model: car.model || 'Unknown',
            year: year,
            price: price,
            mileage: mileage,
            location: car.location || 'Unknown',
            description: car.description || 'No description available',
            condition: condition,
            sellerName: car.sellerName || 'Unknown',
            sellerEmail: car.sellerEmail || 'Unknown',
            sellerPhone: car.sellerPhone || 'Unknown',
            preferredContact: car.preferredContact || 'email',
            bodyType: car.bodyType || '',
            transmission: car.transmission || '',
            fuelType: car.fuelType || '',
            driveType: car.driveType || '',
            images: images
        };
    });
    
    // Update available brands and models for search dropdown
    updateAvailableBrandsModels();
    
    // Filter cars based on current view (favorites/saved)
    let filteredCars = filterCarsByView(allCars);
    
    console.log(`‚úÖ Final processed cars:`, filteredCars);
    
    if (filteredCars.length === 0) {
        showEmptyStateForView();
    } else {
        displayCars(filteredCars);
    }
}

// Filter cars based on current view
function filterCarsByView(cars) {
    if (currentView === 'all') {
        return cars;
    }
    
    const storageKey = currentView === 'favorites' ? 'favoriteCars' : 'savedCars';
    const savedIds = JSON.parse(localStorage.getItem(storageKey)) || [];
    
    return cars.filter(car => savedIds.includes(car.id.toString()));
}

// Update available brands and models for search dropdown
function updateAvailableBrandsModels() {
    availableBrands = new Set();
    availableBrandsModels = {};
    
    allCars.forEach(car => {
        const brand = car.make;
        const model = car.model;
        
        // Add to brands set
        availableBrands.add(brand);
        
        // Add to brands models object
        if (!availableBrandsModels[brand]) {
            availableBrandsModels[brand] = [];
        }
        
        const existingModel = availableBrandsModels[brand].find(m => m.name === model);
        if (existingModel) {
            existingModel.count++;
        } else {
            availableBrandsModels[brand].push({ name: model, count: 1 });
        }
    });
    
    // Sort models alphabetically for each brand
    Object.keys(availableBrandsModels).forEach(brand => {
        availableBrandsModels[brand].sort((a, b) => a.name.localeCompare(b.name));
    });
    
    // Update brand filter dropdown
    updateBrandFilter();
    
    // Update search dropdown if it's open
    const searchDropdown = document.getElementById('searchDropdown');
    if (searchDropdown && searchDropdown.classList.contains('show')) {
        updateSearchDropdown(document.getElementById('searchInput').value);
    }
}

// Update brand filter dropdown with available brands
function updateBrandFilter() {
    const brandFilter = document.getElementById('brandFilter');
    if (!brandFilter) return;
    
    // Store current value
    const currentValue = brandFilter.value;
    
    // Clear existing options (keep "All Brands")
    brandFilter.innerHTML = '<option value="">All Brands</option>';
    
    // Add available brands in alphabetical order
    Array.from(availableBrands).sort().forEach(brand => {
        const option = document.createElement('option');
        option.value = brand;
        option.textContent = brand;
        brandFilter.appendChild(option);
    });
    
    // Restore current value if it still exists
    if (currentValue && availableBrands.has(currentValue)) {
        brandFilter.value = currentValue;
    }
}

function showEmptyStateForView() {
    let message = '';
    
    switch (currentView) {
        case 'favorites':
            message = 'You haven\'t added any cars to your favorites yet. Click the heart icon on any car to add it to your favorites.';
            break;
        case 'saved':
            message = 'You haven\'t saved any cars for later. Click the bookmark icon on any car to save it for later.';
            break;
        default:
            const searchText = document.getElementById('searchInput')?.value || '';
            
            // Check if we have budget filters applied
            if (currentFilters.minPrice || currentFilters.maxPrice) {
                const rangeText = currentFilters.minPrice && currentFilters.maxPrice 
                    ? `N$${currentFilters.minPrice.toLocaleString()} - N$${currentFilters.maxPrice.toLocaleString()}`
                    : currentFilters.minPrice ? `above N$${currentFilters.minPrice.toLocaleString()}` 
                    : currentFilters.maxPrice ? `under N$${currentFilters.maxPrice.toLocaleString()}` 
                    : 'your budget';
                
                message = `No cars found within ${rangeText}. Try adjusting your budget range.`;
            } else if (searchText) {
                message = `No available cars found matching "${searchText}" in our inventory. Try adjusting your search criteria.`;
            } else {
                message = 'No available cars found in our inventory at the moment. Please check back later.';
            }
    }
    
    showEmptyState(message);
}

function showEmptyState(message) {
    const container = document.getElementById('carsContainer');
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (container) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="text-muted">
                    <i class="fas fa-car fa-3x mb-3"></i>
                    <h5>No Cars Found</h5>
                    <p>${message}</p>
                    ${currentView !== 'all' ? `
                        <button class="btn btn-primary mt-3" onclick="document.querySelector('[data-view=\\'all\\']').click()">
                            <i class="fas fa-car me-2"></i>Browse All Cars
                        </button>
                    ` : `
                        <button class="btn btn-primary mt-3" onclick="resetFilters()">
                            <i class="fas fa-refresh me-2"></i>Show All Cars
                        </button>
                    `}
                </div>
            </div>
        `;
    }
    
    // Hide pagination when no cars
    if (paginationContainer) {
        paginationContainer.style.display = 'none';
    }
}

async function displayCars(cars) {
    const container = document.getElementById('carsContainer');
    const paginationContainer = document.getElementById('paginationContainer');
    
    if (!container) {
        console.error('‚ùå carsContainer element not found');
        return;
    }
    
    container.innerHTML = '';
    
    if (!cars || !Array.isArray(cars) || cars.length === 0) {
        showEmptyStateForView();
        return;
    }
    
    console.log(`üé® Displaying ${cars.length} cars for page ${currentPage}`);
    
    // Check auth status once for all cars
    let isAuthenticated = false;
    try {
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();
        isAuthenticated = authData.authenticated;
    } catch (error) {
        console.error('Error checking auth status:', error);
    }
    
    // For each car, check its favorite/saved status
    for (const car of cars) {
        const card = document.createElement('div');
        card.className = 'col-6 col-md-4 col-lg-3 col-xxl mb-3';
        
        // Handle images
        const images = car.images || [];
        let imageUrl = 'https://via.placeholder.com/300x200?text=No+Image';
        let imageCount = 0;
        
        if (images.length > 0) {
            const primaryImage = images.find(img => img.isPrimary) || images[0];
            if (primaryImage && primaryImage.imageUrl) {
                imageUrl = primaryImage.imageUrl.startsWith('http') 
                    ? primaryImage.imageUrl 
                    : primaryImage.imageUrl;
            }
            imageCount = images.length;
        }
        
        // Create specs badges
        const specs = [];
        if (car.bodyType) specs.push(`<span class="badge bg-secondary spec-badge">${car.bodyType}</span>`);
        if (car.transmission) specs.push(`<span class="badge bg-info spec-badge">${car.transmission}</span>`);
        if (car.fuelType) specs.push(`<span class="badge bg-warning spec-badge">${car.fuelType}</span>`);
        if (car.driveType) specs.push(`<span class="badge bg-success spec-badge">${car.driveType}</span>`);
        
        // Format price
        let displayPrice = car.price !== null && car.price !== undefined ? 
            car.price.toString() : 'N/A';
        
        // Check if car is in favorites/saved
        let isFavorited = false;
        let isSaved = false;
        
        if (isAuthenticated) {
            // Check server for logged in users
            try {
                const favResponse = await fetch(`/api/user/favorites/check/${car.id}`);
                const favData = await favResponse.json();
                isFavorited = favData.isFavorited;
                
                const savedResponse = await fetch(`/api/user/saved/check/${car.id}`);
                const savedData = await savedResponse.json();
                isSaved = savedData.isSaved;
            } catch (error) {
                console.error(`Error checking status for car ${car.id}:`, error);
            }
        } else {
            // Use localStorage for guest users
            isFavorited = JSON.parse(localStorage.getItem('favoriteCars') || '[]').includes(car.id.toString());
            isSaved = JSON.parse(localStorage.getItem('savedCars') || '[]').includes(car.id.toString());
        }
        
        card.innerHTML = `
            <div class="card car-card h-100" data-car-id="${car.id}">
                <div class="car-actions">
                    <button class="car-action-btn favorite-btn ${isFavorited ? 'favorited' : ''}" 
                            data-car-id="${car.id}" title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button class="car-action-btn save-btn ${isSaved ? 'active' : ''}" 
                            data-car-id="${car.id}" title="${isSaved ? 'Remove from saved' : 'Save for later'}">
                        <i class="fas fa-bookmark"></i>
                    </button>
                    <button class="car-action-btn price-alert-btn" 
                            data-car-id="${car.id}" data-car-make="${car.make}" data-car-model="${car.model}" title="Set price alert">
                        <i class="fas fa-bell"></i>
                    </button>
                </div>
                
                <div class="car-image-container" onclick="window.location.href='/car-details.html?id=${car.id}'">
                    <img src="${imageUrl}" class="card-img-top main-car-image" alt="${car.make} ${car.model}" 
                         style="height: 220px; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/300x200?text=Image+Not+Found'">
                    
                    ${imageCount > 1 ? `
                    <div class="carousel-controls">
                        <button class="carousel-btn prev-btn" onclick="event.stopPropagation(); rotateCarImages(this, '${car.id}', -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="image-counter">1/${imageCount}</span>
                        <button class="carousel-btn next-btn" onclick="event.stopPropagation(); rotateCarImages(this, '${car.id}', 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    ` : ''}
                </div>
                
                <div class="card-body">
                    <h5 class="card-title">${car.year} ${car.make} ${car.model}</h5>
                    <div class="price text-primary fw-bold fs-4 mb-2">${displayPrice}</div>
                    
                    ${specs.length > 0 ? `
                    <div class="specs mb-2">
                        ${specs.join('')}
                    </div>
                    ` : ''}
                    
                    <div class="details mb-0">
                        <small class="text-muted d-block">
                            <i class="fas fa-tachometer-alt me-1"></i>${car.mileage ? car.mileage.toLocaleString() : 0} km
                        </small>
                        <small class="text-muted d-block">
                            <i class="fas fa-map-marker-alt me-1"></i>${car.location || 'N/A'}
                        </small>
                        <small class="text-muted d-block">
                            <i class="fas fa-car me-1"></i>${car.condition || 'N/A'}
                        </small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-sm" onclick="window.location.href='/car-details.html?id=${car.id}'">
                            <i class="fas fa-eye me-1"></i> View Details
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    }
    
    // Generate pagination based on server-side info
    generatePagination();
    
    // Show pagination container
    if (paginationContainer) {
        paginationContainer.style.display = totalPages > 1 ? 'flex' : 'none';
    }
    
    addCarActionListeners();
    
    // Add click event to entire card (excluding action buttons)
    container.querySelectorAll('.car-card').forEach(card => {
        card.addEventListener('click', function(e) {
            // Only redirect if the click wasn't on an action button or carousel control
            if (!e.target.closest('.car-actions') && !e.target.closest('.carousel-controls')) {
                const carId = this.getAttribute('data-car-id');
                window.location.href = `/car-details.html?id=${carId}`;
            }
        });
    });
}

function generatePagination() {
    const paginationElement = document.getElementById('pagination');
    if (!paginationElement) return;
    
    paginationElement.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `
        <a class="page-link" href="#" aria-label="Previous" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>
            <span aria-hidden="true">&laquo;</span>
        </a>
    `;
    if (currentPage > 1) {
        prevLi.querySelector('.page-link').addEventListener('click', (e) => {
            e.preventDefault();
            applyFilters(currentPage - 1);
        });
    }
    paginationElement.appendChild(prevLi);
    
    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    // Adjust if we're near the end
    if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    // First page and ellipsis if needed
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#">1</a>`;
        firstLi.querySelector('.page-link').addEventListener('click', (e) => {
            e.preventDefault();
            applyFilters(1);
        });
        paginationElement.appendChild(firstLi);
        
        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationElement.appendChild(ellipsisLi);
        }
    }
    
    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        
        if (i !== currentPage) {
            pageLi.querySelector('.page-link').addEventListener('click', (e) => {
                e.preventDefault();
                applyFilters(i);
            });
        }
        
        paginationElement.appendChild(pageLi);
    }
    
    // Last page and ellipsis if needed
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationElement.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
        lastLi.querySelector('.page-link').addEventListener('click', (e) => {
            e.preventDefault();
            applyFilters(totalPages);
        });
        paginationElement.appendChild(lastLi);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `
        <a class="page-link" href="#" aria-label="Next" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>
            <span aria-hidden="true">&raquo;</span>
        </a>
    `;
    if (currentPage < totalPages) {
        nextLi.querySelector('.page-link').addEventListener('click', (e) => {
            e.preventDefault();
            applyFilters(currentPage + 1);
        });
    }
    paginationElement.appendChild(nextLi);
}

function addCarActionListeners() {
    // Favorite buttons
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const carId = this.getAttribute('data-car-id');
            // Don't toggle class here - let toggleFavorite handle it
            toggleFavorite(carId);
        });
    });
    
    // Save buttons
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const carId = this.getAttribute('data-car-id');
            // Don't toggle class here - let toggleSave handle it
            toggleSave(carId);
        });
    });
    
    // Price alert buttons
    document.querySelectorAll('.price-alert-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const carId = this.getAttribute('data-car-id');
            const carMake = this.getAttribute('data-car-make');
            const carModel = this.getAttribute('data-car-model');
            openPriceAlertModal(carId, carMake, carModel);
        });
    });
}

async function toggleFavorite(carId) {
    const button = document.querySelector(`.favorite-btn[data-car-id="${carId}"]`);
    const wasFavorited = button.classList.contains('favorited');
    
    try {
        // Check if user is logged in
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();
        
        if (authData.authenticated) {
            // User is logged in - use server API
            let response;
            let success = false;
            
            if (wasFavorited) {
                // Remove from favorites
                response = await fetch(`/api/user/favorites/${carId}`, {
                    method: 'DELETE'
                });
                success = response.ok;
                
                if (success) {
                    button.classList.remove('favorited');
                    button.title = 'Add to favorites';
                    showToast('Removed from favorites');
                    console.log('‚úÖ Removed from favorites');
                }
            } else {
                // Add to favorites
                response = await fetch(`/api/user/favorites/${carId}`, {
                    method: 'POST'
                });
                success = response.ok;
                
                if (success) {
                    button.classList.add('favorited');
                    button.title = 'Remove from favorites';
                    showToast('Added to favorites');
                    console.log('‚úÖ Added to favorites');
                }
            }
            
            if (!success) {
                throw new Error('Server returned error');
            }
        } else {
            // Guest user - use localStorage
            const favorites = JSON.parse(localStorage.getItem('favoriteCars')) || [];
            const index = favorites.indexOf(carId.toString());
            
            if (index > -1) {
                favorites.splice(index, 1);
                button.classList.remove('favorited');
                button.title = 'Add to favorites';
                showToast('Removed from favorites');
                console.log('‚úÖ Removed from favorites (local)');
            } else {
                favorites.push(carId.toString());
                button.classList.add('favorited');
                button.title = 'Remove from favorites';
                showToast('Added to favorites');
                console.log('‚úÖ Added to favorites (local)');
            }
            
            localStorage.setItem('favoriteCars', JSON.stringify(favorites));
        }
    } catch (error) {
        console.error('Error toggling favorite:', error);
        showToast('Error updating favorites', 'danger');
        // Revert button state on error
        if (wasFavorited) {
            button.classList.add('favorited');
        } else {
            button.classList.remove('favorited');
        }
    }
    
    // If we're in favorites view, update the display
    if (currentView === 'favorites') {
        applyFilters(currentPage);
    }
}

async function toggleSave(carId) {
    const button = document.querySelector(`.save-btn[data-car-id="${carId}"]`);
    const wasSaved = button.classList.contains('active');
    
    try {
        // Check if user is logged in
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();
        
        if (authData.authenticated) {
            // User is logged in - use server API
            let response;
            let success = false;
            
            if (wasSaved) {
                // Remove from saved
                response = await fetch(`/api/user/saved/${carId}`, {
                    method: 'DELETE'
                });
                success = response.ok;
                
                if (success) {
                    button.classList.remove('active');
                    button.title = 'Save for later';
                    showToast('Removed from saved');
                    console.log('‚úÖ Removed from saved');
                }
            } else {
                // Add to saved
                response = await fetch(`/api/user/saved/${carId}`, {
                    method: 'POST'
                });
                success = response.ok;
                
                if (success) {
                    button.classList.add('active');
                    button.title = 'Remove from saved';
                    showToast('Saved for later');
                    console.log('‚úÖ Added to saved');
                }
            }
            
            if (!success) {
                throw new Error('Server returned error');
            }
        } else {
            // Guest user - use localStorage
            const savedCars = JSON.parse(localStorage.getItem('savedCars')) || [];
            const index = savedCars.indexOf(carId.toString());
            
            if (index > -1) {
                savedCars.splice(index, 1);
                button.classList.remove('active');
                button.title = 'Save for later';
                showToast('Removed from saved');
                console.log('‚úÖ Removed from saved (local)');
            } else {
                savedCars.push(carId.toString());
                button.classList.add('active');
                button.title = 'Remove from saved';
                showToast('Saved for later');
                console.log('‚úÖ Added to saved (local)');
            }
            
            localStorage.setItem('savedCars', JSON.stringify(savedCars));
        }
    } catch (error) {
        console.error('Error toggling saved:', error);
        showToast('Error updating saved cars', 'danger');
        // Revert button state on error
        if (wasSaved) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    }
    
    // If we're in saved view, update the display
    if (currentView === 'saved') {
        applyFilters(currentPage);
    }
}

function openPriceAlertModal(carId, carMake, carModel) {
    document.getElementById('alertCarId').value = carId;
    document.getElementById('alertCarMake').value = carMake;
    document.getElementById('alertCarModel').value = carModel;
    
    const modal = new bootstrap.Modal(document.getElementById('priceAlertModal'));
    modal.show();
}

// Store car images data
let carImagesData = {};

function rotateCarImages(button, carId, direction) {
    if (!carImagesData[carId]) {
        const car = allCars.find(c => c.id == carId);
        if (car && car.images) {
            carImagesData[carId] = {
                images: car.images,
                currentIndex: 0
            };
        } else {
            return;
        }
    }
    
    const carData = carImagesData[carId];
    const totalImages = carData.images.length;
    
    carData.currentIndex = (carData.currentIndex + direction + totalImages) % totalImages;
    
    const card = button.closest('.car-card');
    const imgElement = card.querySelector('.main-car-image');
    const counterElement = card.querySelector('.image-counter');
    
    const currentImage = carData.images[carData.currentIndex];
    const imageUrl = currentImage.imageUrl.startsWith('http') ? 
        currentImage.imageUrl : currentImage.imageUrl;
    
    imgElement.src = imageUrl;
    counterElement.textContent = `${carData.currentIndex + 1}/${totalImages}`;
}

// Handle price alert form submission
document.getElementById('submitPriceAlert').addEventListener('click', async function() {
    const firstName = document.getElementById('alertFirstName').value;
    const lastName = document.getElementById('alertLastName').value;
    const phone = document.getElementById('alertPhone').value;
    const email = document.getElementById('alertEmail').value;
    const carId = document.getElementById('alertCarId').value;
    const carMake = document.getElementById('alertCarMake').value;
    const carModel = document.getElementById('alertCarModel').value;
    const similarCars = document.getElementById('similarCars').checked;
    
    // Find the car to get current price and additional details
    const car = allCars.find(c => c.id == carId);
    const currentPrice = car ? car.price : 0;
    
    if (!firstName || !lastName || !phone || !email || !email.includes('@')) {
        alert('Please fill in all required fields with valid information');
        return;
    }
    
    try {
        // Check if user is logged in
        const authResponse = await fetch('/api/auth/status');
        const authData = await authResponse.json();
        
        const backendAlert = {
            firstName: firstName,
            lastName: lastName,
            email: email,
            phone: phone,
            carId: carId,
            carMake: carMake,
            carModel: carModel,
            carYear: car ? car.year : null,
            carPrice: currentPrice,
            carMileage: car ? car.mileage : null,
            carLocation: car ? car.location : null,
            similarCars: similarCars
        };
        
        // If user is logged in, we'll use the user alerts endpoint which will associate the alert with their account
        let url = '/api/price-alerts';
        let method = 'POST';
        
        if (authData.authenticated) {
            // Use the user-specific alerts endpoint for logged in users
            url = '/api/user/alerts';
            // Remove firstName/lastName/email from the request - it will use the user's data
            delete backendAlert.firstName;
            delete backendAlert.lastName;
            delete backendAlert.email;
            delete backendAlert.phone;
        }
        
        console.log('üì§ Sending price alert to:', url, backendAlert);
        
        // Send to backend API
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(backendAlert)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to save price alert');
        }
        
        const result = await response.json();
        console.log('‚úÖ Price alert saved:', result);
        
        showToast('Price alert set successfully!');
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('priceAlertModal'));
        modal.hide();
        
        document.getElementById('priceAlertForm').reset();
        
    } catch (error) {
        console.error('Error setting price alert:', error);
        alert('There was an error setting your price alert: ' + error.message);
    }
});

// Toast notification function
function showToast(message) {
    let toastElement = document.getElementById('actionToast');
    if (!toastElement) {
        const toastContainer = document.createElement('div');
        toastContainer.innerHTML = `
            <div id="actionToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        document.body.appendChild(toastContainer.firstElementChild);
        toastElement = document.getElementById('actionToast');
    }
    
    const toastBody = toastElement.querySelector('.toast-body');
    toastBody.textContent = message;
    
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
}

// Load search dropdown data
async function loadSearchDropdownData() {
    try {
        const response = await fetch('/api/cars/brands-models/counts');
        const data = await response.json();
        
        if (data.success) {
            availableBrandsModels = data.brandsWithModels;
            console.log('‚úÖ Loaded search dropdown data:', availableBrandsModels);
        }
    } catch (error) {
        console.error('‚ùå Error loading search dropdown data:', error);
    }
}
</script>
   <!-- Footer -->
    <footer class="footer bg-dark text-white pt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <h5><i class="fas fa-car-luxury"></i> Exi Dealers</h5>
                    <p>Your trusted partner for buying premium quality vehicles.</p>
                </div>
                <div class="col-md-2 mb-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="view.html">Browse Cars</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4">
                    <h5>Premium Brands</h5>
                    <ul class="list-unstyled">
                        <li><a href="#">Mercedes-Benz</a></li>
                        <li><a href="#">BMW</a></li>
                        <li><a href="#">Audi</a></li>
                        <li><a href="#">Lexus</a></li>
                        <li><a href="#">Land Rover</a></li>
                    </ul>
                </div>
                <div class="col-md-3 mb-4">
                    <h5>Contact Info</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-map-marker-alt me-2"></i> Windhoek, Namibia</li>
                        <li><i class="fas fa-phone me-2"></i> +264 (81) 267 5760</li>
                        <li><i class="fas fa-envelope me-2"></i> sales@exidealers.com</li>
                    </ul>
                </div>
            </div>
            <hr class="bg-light" />
            <div class="row">
                <div class="col-md-6 mb-3">
                    <p>&copy; 2026 Exi Dealers. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>